<script>
    function newThread(){
        $('.modal').modal('open');
    }
    $("#edit-fab").click(newThread);

    function backToIndex(){
        $('#threadContainer').empty();
        $('#threadForm').removeClass("invisible");
        $("#submitThreadButton").removeClass("disabled");
        history.pushState({}, "index", "/");
    }

    function submitThread(){
        var formObject = {}
        var formArray = $("#getthread").serializeArray();
        $.each(formArray, function (i, item) {
            formObject[item.name] = item.value;
        });
        $("#submitThreadButton").addClass("disabled");
        $.ajax({
            url: "/api/thread/" + formObject['thread'],
            type: "POST",
            contentType: "application/json; charset=utf-8",
            data: JSON.stringify(formObject),
            dataType: "json",
            success: function (data) {
                console.log(data)
                console.log(data.data)
                console.log(data.data['code'])
                if (data['code'] === 200){
                    $('#threadForm').addClass("invisible");
                    $('#threadContainer').append(`<div class="waves-effect waves-grey btn-flat" id="backToIndex"><i class="small material-icons">chevron_left</i><span>返回</span></div>`)
                    $('#backToIndex').click(backToIndex);
                    thread = data.data['thread']
                    $('#threadContainer').append(`<h1 id="thread-title">${thread['title']}</h1>`)
                    for (var i in data.data['posts']) {
                        post = data.data['posts'][i]
                        console.log(post)
                        $('#threadContainer').append(`<div class="col l12 s12 card-panel white thread-card" id="post-${post['floor']}">
                            <div class="card-content">
                                <div class="content" id="content-${post['floor']}">${post['content']}</div>
                                <div class="post-metadata">
                                    <span class="grey-text username"><i class="tiny material-icons">account_box</i>${post['username']}</span>
                                    <span class="grey-text time"><i class="tiny material-icons">access_time</i>${post['time']}</span>
                                </div>
                                <div class="floor">
                                    <span class="floor-number grey-text">${post['floor']}</span>
                                </div>
                            </div>
                        </div>`);
                    }
                    if (thread['is_closed']){
                        
                    }
                    history.pushState({}, "index", "/thread/"+thread['thread']);
                } else if (data['code'] === 403){
                    M.toast({html: `403 - ${data.data['message']}`})
                    $("#submitThreadButton").removeClass("disabled")
                }
            },
            error: function(e) {
                console.log(e)
                M.toast({html: `${e['status']} - ${e['statusText']}`})
                $("#submitThreadButton").removeClass("disabled")
            }
        });
    }
    $('#submitThreadButton').click(submitThread)
    $('#backToIndex').click(backToIndex)
</script>